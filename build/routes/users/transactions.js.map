{"version":3,"sources":["transactions.es6"],"names":[],"mappings":"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","file":"transactions.js","sourcesContent":["var express = require('express');\r\nvar connection = require('../../connection');\r\nimport * as utility from \"../../utility\";\r\nvar passport = require('passport');\r\nvar async = require('async');\r\n\r\nvar userModel = require('../../models/user');\r\nvar storeModel = require('../../models/store');\r\nvar transactionModel = require('../../models/transactions');\r\n\r\nvar router = express.Router();\r\n\r\n// Ensure sure the user is authenticated\r\nfunction ensureAuthenticated(req, res, next) {\r\n    if (req.isAuthenticated()) {\r\n        return next();\r\n    }\r\n\r\n    res.redirect('/');\r\n}\r\n\r\nrouter.get('/', ensureAuthenticated, (req, res, next) => {\r\n    renderTransactionHistoryPage({ title: 'Transaction History' }, req, res, next);\r\n});\r\n\r\nrouter.get('/add-transaction', ensureAuthenticated, (req, res, next) => {\r\n    renderAddTransactionPage({title: 'Add Transaction'}, req, res, next);\r\n}); //end get for /add-transaction\r\n\r\nrouter.get('/add-transaction/:employee', ensureAuthenticated, (req, res, next) => {\r\n    if (req.user.privileged <= 2) {\r\n        return res.redirect('/users/');\r\n    }\r\n\r\n    renderAddTransactionPage({title: 'Add Transaction'}, req, res, next);\r\n}); //End get for add-transaction/:employee\r\n\r\nrouter.post('/', ensureAuthenticated, (req, res, next) => {\r\n    let transactionId = req.body.id;\r\n\r\n    transactionModel.deleteTransaction(transactionId, (err, result) => {\r\n        if (err) {\r\n            utility.log({ type: 'error', message: 'Error deleting transaction_id ' + transactionId + 'Error: ' + err.message });\r\n            return res.end('Error: ' + err.message);\r\n        }\r\n\r\n        res.send(transactionId);\r\n    });\r\n});\r\n\r\n//When the add transaction page is submitted\r\nrouter.post('/add-transaction', ensureAuthenticated, (req, res, next) => {\r\n    var returnObj = {\r\n        title: 'Add Transaction'\r\n    };\r\n\r\n    if (req.body.employeeDropdown == undefined) {\r\n        utility.log({ type: 'log', message: \"No user selected\" });\r\n        returnObj['message'] = 'Please select a user';\r\n        return renderAddTransactionPage(returnObj, req, res, next);\r\n    }\r\n\r\n    if (req.body.transactionDropdown == undefined) {\r\n        utility.log({ type: 'log', message: \"No transaction selected\" });\r\n        returnObj['message'] = 'Please select a transaction type';\r\n        return renderAddTransactionPage(returnObj, req, res, next);\r\n    }\r\n\r\n    //Get all the data from the form\r\n    let data = req.body;\r\n\r\n    //For transactions\r\n    let t_number = req.body.employeeDropdown;\r\n    let store_id = req.body.storeDropdown;\r\n    let currentDate = undefined;\r\n    let transaction_type = undefined;\r\n\r\n    //For Transaction Items\r\n    let activation_type = undefined;\r\n    let device_type = undefined;\r\n    let warranty_type = undefined;\r\n    let attached = undefined;\r\n    let revenue = 0;\r\n    let num_of_accessories = undefined;\r\n    let sbs_activation = undefined;\r\n\r\n    //For Additional Metrics\r\n    let hasMetrics = false;\r\n    let hasItems = false;\r\n\r\n    let learning_sessions = undefined;\r\n    let learning_sessions_count = data.learningSessionsCount; // Get the value from the input\r\n\r\n    //Assign corresponding id if the value is greater than 0\r\n    if (learning_sessions_count > 0) {\r\n        learning_sessions = 1;\r\n        hasMetrics = true;\r\n    }\r\n\r\n    let credit_card = undefined;\r\n    let credit_card_count = data.creditCardCount; // Get the value from the input\r\n\r\n    //Assign corresponding id if the value is greater than 0\r\n    if (credit_card_count > 0) {\r\n        credit_card = 6;\r\n        hasMetrics = true;\r\n    }\r\n\r\n    let appointments = undefined;\r\n    let appointments_count = data.appointmentsCount; // Get the value from the input\r\n\r\n    //Assign corresponding id if the value is greater than 0\r\n    if (appointments_count > 0) {\r\n        appointments = 3;\r\n        hasMetrics = true;\r\n    }\r\n\r\n    let aotm = undefined;\r\n    let aotm_count = data.aotmCount; // Get the value from the input\r\n\r\n    //Assign corresponding id if the value is greater than 0\r\n    if (aotm_count > 0) {\r\n        aotm = 2;\r\n        hasMetrics = true;\r\n    }\r\n\r\n    let critters = undefined;\r\n    let critters_count = data.crittersCount; // Get the value from the input\r\n\r\n    //Assign corresponding id if the value is greater than 0\r\n    if (critters_count > 0) {\r\n        critters = 4;\r\n        hasMetrics = true;\r\n    }\r\n\r\n    let donations = undefined;\r\n    let donations_count = data.donationsCount; // Get the value from the input\r\n\r\n    //Assign corresponding id if the value is greater than 0\r\n    if (donations_count > 0) {\r\n        donations = 5;\r\n        hasMetrics = true;\r\n    }\r\n\r\n    let transaction = undefined;\r\n    let transaction_items = undefined;\r\n\r\n    //Objects for metrics\r\n    let learning_sessions_obj = undefined;\r\n    let credit_card_obj = undefined;\r\n    let appointments_obj = undefined;\r\n    let aotm_obj = undefined;\r\n    let critters_obj = undefined;\r\n    let donations_obj = undefined;\r\n\r\n    let metrics = undefined;\r\n\r\n    transaction_items = data;\r\n\r\n    //Call the following methods in order\r\n    async.series([getData, addTransaction, addTransactionItems, addMetrics, pageRedirect]);\r\n\r\n\r\n    ///**\r\n    // * Second method in the async series\r\n    // * Get the users store number by their t_number\r\n    // * @param fnCallback\r\n    // */\r\n    //function getStoreID(fnCallback) {\r\n    //    storeModel.getFirstStoreByTNumber(t_number, (err, rows) => {\r\n    //        if (err) {\r\n    //            throw next(err);\r\n    //        }\r\n    //        else if (rows.length <= 0) {\r\n    //            console.error('Invalid profile id.');\r\n    //            return res.redirect('/users/');\r\n    //        }\r\n    //        else {\r\n    //            store_id = rows[0].store_id;\r\n    //            fnCallback(null);\r\n    //        }\r\n    //    });\r\n    //} //End getStoreID\r\n\r\n    /**\r\n     * Third method in the async series\r\n     * Gets all the data from the form and stores it in objects\r\n     * @param fnCallback\r\n     */\r\n    function getData(fnCallback) {\r\n        currentDate = getCurrentDate();\r\n        transaction_type = data.transactionDropdown;\r\n\r\n        //Transaction Items\r\n        activation_type = data.activationDropdown;\r\n        device_type = data.deviceDropdown;\r\n        warranty_type = data.warrantyDropdown;\r\n        attached = data.attachedDropdown;\r\n\r\n        if (data.revenueText != '') {\r\n            revenue = data.revenueText;\r\n        }\r\n\r\n        num_of_accessories = data.accessoryCount;\r\n\r\n        if (data.sbsActivation == \"on\") {\r\n            sbs_activation = 1;\r\n        } else {\r\n            sbs_activation = 0;\r\n        }\r\n\r\n        //Transaction object\r\n        transaction = {\r\n            t_number: t_number,\r\n            store_id: store_id,\r\n            transaction_date: currentDate,\r\n            transaction_type: transaction_type\r\n        };\r\n\r\n\r\n\r\n        //Learning sessions object\r\n        learning_sessions_obj = {\r\n            transaction_id: undefined,\r\n            additional_metrics_items_type: learning_sessions,\r\n            additional_metrics_items_count: learning_sessions_count\r\n        };\r\n\r\n        //Credit card object\r\n        credit_card_obj = {\r\n            transaction_id: undefined,\r\n            additional_metrics_items_type: credit_card,\r\n            additional_metrics_items_count: credit_card_count\r\n        };\r\n\r\n        //Appointments object\r\n        appointments_obj = {\r\n            transaction_id: undefined,\r\n            additional_metrics_items_type: appointments,\r\n            additional_metrics_items_count: appointments_count\r\n        };\r\n\r\n        //AOTM object\r\n        aotm_obj = {\r\n            additional_metrics_items_type: aotm,\r\n            additional_metrics_items_count: aotm_count\r\n        };\r\n\r\n        //Critters object\r\n        critters_obj = {\r\n            transaction_id: undefined,\r\n            additional_metrics_items_type: critters,\r\n            additional_metrics_items_count: critters_count\r\n        };\r\n\r\n        //Donations object\r\n        donations_obj = {\r\n            transaction_id: undefined,\r\n            additional_metrics_items_type: donations,\r\n            additional_metrics_items_count: donations_count\r\n        };\r\n\r\n        //Store the objects in an array for looping\r\n        metrics = [learning_sessions_obj, credit_card_obj, appointments_obj, aotm_obj, critters_obj, donations_obj];\r\n\r\n        fnCallback(null);\r\n    }//end getData\r\n\r\n    /**\r\n     * Fourth method in the async series\r\n     * @param fnCallback\r\n     */\r\n    function addTransaction(fnCallback) {\r\n        //Add the transaction models and assign the insert ID to the other objects\r\n        transactionModel.addTransaction(transaction, (err, result) => {\r\n            transaction_items['transaction_id'] = result.insertId;\r\n            learning_sessions_obj['transaction_id'] = result.insertId;\r\n            credit_card_obj['transaction_id'] = result.insertId;\r\n            appointments_obj['transaction_id'] = result.insertId;\r\n            aotm_obj['transaction_id'] = result.insertId;\r\n            critters_obj['transaction_id'] = result.insertId;\r\n            donations_obj['transaction_id'] = result.insertId;\r\n            fnCallback(null);\r\n        });\r\n    } //End addTransaction\r\n\r\n    /**\r\n     * Fifth method in the async series\r\n     * Add the transaction items, if there are some\r\n     * @param fnCallback\r\n     */\r\n    function addTransactionItems(fnCallback) {\r\n\r\n        //Check if any of the these fields have be filled out, to know if we are inserting or not\r\n        hasItems = activation_type != undefined || device_type != undefined ||\r\n            warranty_type != undefined || attached != 'no' || revenue != '' ||\r\n            num_of_accessories != '0' || sbs_activation != 0;\r\n\r\n        //If there are transaction items, insert record to the DB\r\n        if (hasItems) {\r\n            let transaction_item = {};\r\n\r\n            //Add the object(s) to the database\r\n            async.eachSeries(Object.keys(transaction_items), (item, callback) => {\r\n                if(item.indexOf('activationDropdown') >= 0) {\r\n                    transaction_item['activation_type'] = transaction_items[item];\r\n                    callback(null);\r\n                }\r\n                else if(item.indexOf('sbsActivation') >= 0) {\r\n                    transaction_item['sbs_activation'] = 1;\r\n                    callback(null);\r\n                }\r\n                else if(item.indexOf('deviceDropdown') >= 0) {\r\n                    transaction_item['device_type'] = transaction_items[item];\r\n                    callback(null);\r\n                }\r\n                else if(item.indexOf('warrantyDropdown') >= 0) {\r\n                    transaction_item['warranty_type'] = transaction_items[item];\r\n                    callback(null);\r\n                }\r\n                else if(item.indexOf('attachedDropdown') >= 0) {\r\n                    transaction_item['attached'] = transaction_items[item];\r\n                    callback(null);\r\n                }\r\n                else if(item.indexOf('accessoryCount') >= 0) {\r\n                    transaction_item['num_of_accessories'] = transaction_items[item];\r\n                    callback(null);\r\n                }\r\n                else if(item.indexOf('revenue') >= 0) {\r\n                    transaction_item['revenue'] = transaction_items[item];\r\n                    if(transaction_item['revenue'] == ''){\r\n                        transaction_item['revenue'] = 0.00;\r\n                    }\r\n                    transaction_item['transaction_id'] = transaction_items['transaction_id'];\r\n                    if(transaction_item['sbs_activation'] == undefined){\r\n                        transaction_item['sbs_activation'] = 0;\r\n                    }\r\n                    transactionModel.addTransactionItems(transaction_item, (err, result) => {\r\n                        if (!err) {\r\n                            callback(null);\r\n                        } else {\r\n                            utility.log({ type: 'error', message: err });\r\n                            callback(null);\r\n                        }\r\n                    });\r\n                }\r\n                else {\r\n                   callback(null);\r\n                }\r\n            });\r\n        } else {\r\n            utility.log({ type: 'log', message: \"No Items\" });\r\n        }\r\n\r\n        fnCallback(null);\r\n    } //End Transaction Items\r\n\r\n\r\n    /**\r\n     * Sixth method in the async series\r\n     * Add any additional metrics te transaction may have\r\n     * @param fnCallback\r\n     */\r\n    function addMetrics(fnCallback) {\r\n        if (hasMetrics) {\r\n            utility.log({ type: 'log', message: \"Additional Metrics\" });\r\n\r\n            //Foreach object in the array of metrics objects\r\n            metrics.forEach((item) => {\r\n                if (item.additional_metrics_items_count > 0) {\r\n                    transactionModel.addAdditionalMetrics(item, (err, result) => {\r\n                        if (!err) {\r\n                            utility.log({ type: 'log', message: item + ' added' });\r\n                        } else {\r\n                            utility.log({ type: 'error', message: 'Error!' + item + ' not added' + err });\r\n                        }\r\n                    });\r\n                } else {\r\n                    utility.log({ type: 'log', message: item + \" not added\" });\r\n                }\r\n            });\r\n\r\n        } else {\r\n            utility.log({ type: 'log', message: \"No Metrics\" });\r\n        }\r\n\r\n        fnCallback(null);\r\n    } //End addMetrics\r\n\r\n    /**\r\n     * Seventh and last method in the async series\r\n     * Simply redirect to the summary page\r\n     * @param fnCallback\r\n     */\r\n    function pageRedirect(fnCallback) {\r\n        if(req.body.saveTransactionNew == undefined) {\r\n            req.session.success = true;\r\n            res.redirect('/users/transactions');\r\n        } else {\r\n            res.redirect('/users/transactions/add-transaction');\r\n        }\r\n\r\n        fnCallback(null);\r\n    }\r\n\r\n}); //end post for add-transaction\r\n\r\n/**\r\n * Custom function that return the current date and time\r\n * @returns {string} in yyyy:mm:dd hh:mm:ss format\r\n */\r\nfunction getCurrentDate() {\r\n    let date = new Date();\r\n\r\n    let hour = date.getHours();\r\n    hour = (hour < 10 ? \"0\" : \"\") + hour;\r\n\r\n    let min = date.getMinutes();\r\n    min = (min < 10 ? \"0\" : \"\") + min;\r\n\r\n    let sec = date.getSeconds();\r\n    sec = (sec < 10 ? \"0\" : \"\") + sec;\r\n\r\n    let year = date.getFullYear();\r\n\r\n    let month = date.getMonth() + 1;\r\n    month = (month < 10 ? \"0\" : \"\") + month;\r\n\r\n    let day = date.getDate();\r\n    day = (day < 10 ? \"0\" : \"\") + day;\r\n\r\n    return year + \":\" + month + \":\" + day + \" \" + hour + \":\" + min + \":\" + sec;\r\n} //end getCurrentDate\r\n\r\n/**\r\n * This method pulls all the data required to load the transaction history page from the database and loads the page\r\n * @param returnObj\r\n * @param req\r\n * @param res\r\n * @param next\r\n */\r\nfunction renderTransactionHistoryPage(returnObj, req, res, next) {\r\n    storeModel.getStoresByTNumber(req.user.t_number, (err, result) => {\r\n        if(err) {\r\n            throw next(err);\r\n        } //end if\r\n\r\n        returnObj['stores'] = result;\r\n\r\n        transactionModel.getTransactionss((err, result) => {\r\n            if(err) {\r\n                throw next(err);\r\n            } //end if\r\n\r\n            returnObj['transactions'] = result;\r\n\r\n            transactionModel.getTransactionTypes((err, result) => {\r\n                if (err) {\r\n                    throw next(err);\r\n                } ///end if\r\n\r\n                returnObj['transactionTypes'] = {};\r\n                for(let index in result) {\r\n                    if(!result.hasOwnProperty(index)) { continue; }\r\n                    returnObj['transactionTypes'][result[index].transaction_type_id] = result[index].transaction_types;\r\n                } //end for\r\n\r\n                transactionModel.getTransactionItems((err, result) => {\r\n                    if(err) {\r\n                        throw next(err);\r\n                    } //end if\r\n\r\n                    returnObj['transactionItems'] = result;\r\n\r\n                    transactionModel.getAdditionalMetricItems((err, result) => {\r\n                        if (err) {\r\n                            throw next(err);\r\n                        } //end if\r\n\r\n                        returnObj['additionalMetricItems'] = result;\r\n\r\n                        transactionModel.getActivation((err, result) => {\r\n                            if (err) {\r\n                                throw next(err);\r\n                            } //end if\r\n\r\n                            returnObj['activationTypes'] = {};\r\n                            for(let index in result) {\r\n                                if(!result.hasOwnProperty(index)) { continue; }\r\n                                returnObj['activationTypes'][result[index].activation_type_id] = result[index].activation_types;\r\n                            } //end if\r\n\r\n                            transactionModel.getDevice((err, result) => {\r\n                                if (err) {\r\n                                    throw next(err);\r\n                                } //end if\r\n\r\n                                returnObj['deviceTypes'] = {};\r\n                                for(let index in result) {\r\n                                    if(!result.hasOwnProperty(index)) { continue; }\r\n                                    returnObj['deviceTypes'][result[index].device_type_id] = result[index].device_types;\r\n                                } //end for\r\n\r\n                                transactionModel.getWarranty((err, result) => {\r\n                                    if (err) {\r\n                                        throw next(err);\r\n                                    } //end if\r\n\r\n                                    returnObj['warrantyTypes'] = {};\r\n                                    for(let index in result) {\r\n                                        if(!result.hasOwnProperty(index)) { continue; }\r\n                                        returnObj['warrantyTypes'][result[index].warranty_type_id] = result[index].warranty_types;\r\n                                    } //end for\r\n\r\n                                    returnObj['stores'].forEach((storeVal, storeIndex) => {\r\n                                        returnObj['stores'][storeIndex]['transactions'] = returnObj['transactions'].filter(\r\n                                            (transVal) => transVal.store_id === storeVal.store_id\r\n                                        ); //end filter;\r\n\r\n                                        returnObj['stores'][storeIndex]['transactions'].forEach((transVal, transIndex) => {\r\n                                            returnObj['stores'][storeIndex]['transactions'][transIndex]['transactionItems'] = returnObj['transactionItems']\r\n                                                .filter((transItemVal) => transItemVal.transaction_id === transVal.transaction_id);\r\n\r\n                                            returnObj['stores'][storeIndex]['transactions'][transIndex]['additionalMetricItems'] = returnObj['additionalMetricItems']\r\n                                                .filter((addMetricItemVal) => addMetricItemVal.transaction_id === transVal.transaction_id);\r\n\r\n                                            returnObj['stores'][storeIndex]['transactions'][transIndex]['totalRevenue'] = 0;\r\n                                            returnObj['stores'][storeIndex]\r\n                                                ['transactions'][transIndex]['transactionItems'].forEach((transItemVal, transItemIndex) => {\r\n                                                returnObj['stores'][storeIndex]\r\n                                                    ['transactions'][transIndex]\r\n                                                    ['transactionItems'][transItemIndex]\r\n                                                    ['activation'] = returnObj['activationTypes'][transItemVal.activation_type];\r\n                                                returnObj['stores'][storeIndex]\r\n                                                    ['transactions'][transIndex]\r\n                                                    ['transactionItems'][transItemIndex]\r\n                                                    ['device'] = returnObj['deviceTypes'][transItemVal.device_type];\r\n                                                returnObj['stores'][storeIndex]\r\n                                                    ['transactions'][transIndex]\r\n                                                    ['transactionItems'][transItemIndex]\r\n                                                    ['warranty'] = returnObj['warrantyTypes'][transItemVal.warranty_type];\r\n                                                returnObj['stores'][storeIndex]\r\n                                                    ['transactions'][transIndex]\r\n                                                    ['transactionItems'][transItemIndex]\r\n                                                    ['transactionType'] = returnObj['transactionTypes'][transVal.transaction_type];\r\n                                                returnObj['stores'][storeIndex]['transactions'][transIndex]['totalRevenue'] += transItemVal.revenue;\r\n                                            }); //end for each\r\n                                        }); //end for each\r\n                                    }); //end for each\r\n\r\n                                    returnObj['storesObj'] = JSON.stringify(returnObj['stores']);\r\n\r\n                                    let storeIds = [];\r\n                                    for(let storeIndex in returnObj['stores']) {\r\n                                        if(!returnObj['stores'].hasOwnProperty(storeIndex)) { continue; }\r\n                                        storeIds.push(returnObj['stores'][storeIndex].store_id);\r\n                                    }\r\n\r\n                                    userModel.getAllUsersByStoreIds(storeIds, (err, result) => {\r\n                                            if(err) {\r\n                                                throw next(err);\r\n                                            } //end if\r\n\r\n                                            //Display success message on adding a transaction\r\n                                            if(req.session.success) {\r\n                                                req.flash('success_messages', 'Transaction successfully added!');\r\n                                                res.locals.success_messages = req.flash('success_messages');\r\n                                                req.session.success = false;\r\n                                            }  //end if\r\n\r\n                                            returnObj['users'] = result;\r\n                                            returnObj['usersObj'] = JSON.stringify(result);\r\n                                            returnObj['selectedEmployee']= req.user.t_number;\r\n\r\n                                            return res.render('transactions/transactions', returnObj);\r\n                                    }); //getAllUsersByStoreID;\r\n                                }); //getWarranty\r\n                            }); //get devices\r\n                        }); //end getActivation\r\n                    }); //end getAdditionalMetricItems\r\n                }); //end getTransactionItems\r\n            }); //end getTransactionTypes\r\n        }); //end getTransactions\r\n    }); //end getStoresByTNumber\r\n} //End renderTransactionHistoryPage\r\n\r\n/**\r\n * This method pulls all the data required to load the add-transaction page from the database and loads the page\r\n * @param returnObj\r\n * @param req\r\n * @param res\r\n * @param next\r\n */\r\nfunction renderAddTransactionPage(returnObj, req, res, next) {\r\n    storeModel.getAllStoresAndUsers((err, storeResults) => {\r\n        //If an error is thrown\r\n        if (err) {\r\n            returnObj['message'] = req.flash('Our database servers maybe down. Please try again.');\r\n            //Render the page wth error messages\r\n            return res.render('transactions/add-transaction', returnObj);\r\n        } //End if\r\n\r\n\r\n\r\n        userModel.getAllUsersByStoreID(req.session.store_id, (err, userResult) => {\r\n            //If an error is thrown\r\n            if (err) {\r\n                returnObj['message'] = req.flash('Our database servers maybe down. Please try again.');\r\n                //Render the page wth error messages\r\n                return res.render('transactions/add-transaction', returnObj);\r\n            } //End if\r\n\r\n            transactionModel.getTransactions((err, transactionResults) => {\r\n                //If an error is thrown\r\n                if (err) {\r\n                    returnObj['message'] = req.flash('Our database servers maybe down. Please try again.');\r\n                    //Render the page wth error messages\r\n                    return res.render('transactions/add-transaction', returnObj);\r\n                } //End if\r\n\r\n                transactionModel.getActivation((err, activationResults) => {\r\n                    //If an error is thrown\r\n                    if (err) {\r\n                        returnObj['message'] = req.flash('Our database servers maybe down. Please try again.');\r\n                        //Render the page wth error messages\r\n                        return res.render('transactions/add-transaction', returnObj);\r\n                    } //End if\r\n\r\n                    transactionModel.getDevice((err, deviceResults) => {\r\n                        //If an error is thrown\r\n                        if (err) {\r\n                            returnObj['message'] = req.flash('Our database servers maybe down. Please try again.');\r\n                            //Render the page wth error messages\r\n                            return res.render('transactions/add-transaction', returnObj);\r\n                        } //End if\r\n\r\n                        transactionModel.getWarranty((err, warrantyResults) => {\r\n                            //If an error is thrown\r\n                            if (err) {\r\n                                returnObj['message'] = req.flash('Our database servers maybe down. Please try again.');\r\n                                //Render the page wth error messages\r\n                                return res.render('transactions/add-transaction', returnObj);\r\n                            } //End if\r\n\r\n                            returnObj['users'] = userResult;\r\n                            returnObj['transactions'] = transactionResults;\r\n                            returnObj['activations'] = activationResults;\r\n                            returnObj['devices'] = deviceResults;\r\n                            returnObj['warrantys'] = warrantyResults;\r\n                            returnObj['stores'] = storeResults;\r\n                            returnObj['selectedEmployee'] = req.user.t_number;\r\n                            returnObj['defaultStore'] = req.user.store_id;\r\n\r\n                            returnObj['warrentysObj'] = JSON.stringify(returnObj['warrantys']);\r\n                            returnObj['devicesObj'] = JSON.stringify(returnObj['devices']);\r\n                            returnObj['activationsObj'] = JSON.stringify(returnObj['activations']);\r\n                            returnObj['storesObject'] = JSON.stringify(returnObj['stores']);\r\n\r\n                            return res.render('transactions/add-transaction', returnObj);\r\n                        }); //end getWarranty\r\n                    }); //end getDevice\r\n                }); //end getActivation\r\n            }); //end getTransactions\r\n        }); //end getAll\r\n    }); //end getAllStores\r\n} //End renderAddTransactionPage\r\n\r\nmodule.exports = router;"]}