{"version":3,"sources":["selling-hours.es6"],"names":[],"mappings":"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","file":"selling-hours.js","sourcesContent":["/**\n * Created by Jacob on 2016-05-29.\n */\nvar express = require('express');\nvar connection = require('../../connection');\nimport * as utility from \"../../utility\";\nvar passport = require('passport');\n\nvar moment = require('../../bower_components/bootstrap-daterangepicker/moment.min.js');\n\n\n\n\nvar userModel = require('../../models/user');\nvar storeModel = require('../../models/store');\nvar sellingHoursModel = require('../../models/selling-hours');\nvar returnObj = {};\nvar router = express.Router();\n\nvar endOfWeek = moment().startOf('isoWeek').add(5,'day').format('YYYY-MM-DD');\n\n\nrouter.get('/', ensureAuthenticated, function (req, res, next) {\n    returnObj['message'] = undefined;\n    let storeIds = [];\n\n    if (!req.body) { return res.sendStatus(400); }\n\n    returnObj['title'] = 'Selling Hours';\n    storeModel.getStoresByTNumber(req.user.t_number, (err, result) => {\n        if (err) {\n            throw next(err);\n        } //end if\n\n        returnObj['stores'] = result;\n        returnObj['storesObj'] = JSON.stringify(returnObj['stores']);\n        for(let storeIndex in returnObj['stores']) {\n            if(!returnObj['stores'].hasOwnProperty(storeIndex)) { continue; }\n            storeIds.push(returnObj['stores'][storeIndex].store_id);\n        }\n\n        userModel.getAllUsersByStoreIds(storeIds, (err, result) => {\n            if (err) {\n                throw next(err);\n            } //end if\n\n            returnObj['users'] = [];\n            result.forEach((user) => {\n                delete user['password'];\n                returnObj['users'].push(user);\n            });\n\n            returnObj['usersObj'] = JSON.stringify(returnObj['users']);\n            returnObj['selectedEmployee'] = req.user.t_number;\n            sellingHoursModel.getAllHours(req.session.store_id,(err, result) => {\n                if (err) {\n                    throw next(err);\n                } //end if)\n                returnObj['hours'] = result;\n                returnObj['hoursObj'] = JSON.stringify(result);\n                if (req.session.success) {\n                    req.flash('success_messages', 'success');\n                    req.session.success = false;\n                }  //end if\n\n                sellingHoursModel.getBudgets(endOfWeek,(err, budgetResults) => {\n                    if (err) {\n                        throw next(err);\n                    } //end if\n                    returnObj['budgets'] = budgetResults;\n                    returnObj['budgetsObj'] = JSON.stringify(returnObj['budgets']);\n                    return res.render('selling-hours/selling-hours', returnObj);\n                });\n            });\n        });\n    });\n});\n\nrouter.post('/', ensureAuthenticated, (req, res, next) => {\n    if(req.body.dateRange != undefined && req.body.dateRange != '') {\n        var selectedDate = req.body.dateRange;\n        sellingHoursModel.getHoursByDate(req.session.store_id, selectedDate, (err, result) => {\n            if (err) {\n                throw next(err);\n            } //end if)\n            returnObj['hours'] = result;\n            returnObj['hoursObj'] = JSON.stringify(result);\n            returnObj['selectedDate'] = selectedDate;\n            console.log(returnObj['selectedDate']);\n            if (req.session.success) {\n                req.flash('success_messages', 'success');\n                req.session.success = false;\n            }  //end if\n            return res.redirect('/users/selling-hours');\n        });\n    }\n    else {\n        var data = req.body.name;\n        data = data.split(',');\n        for (var aData in data) {\n            console.log(aData);\n        }\n        //Update selling hours\n        sellingHoursModel.updateHoursByID([req.body.value, data[0], data[1], data[2]], (err, result) => {\n            if (err) {\n                return res.end('Error: ' + err.message);\n            }\n\n            //No rows affected, guess we have to insert\n            if (result == 0) {\n                utility.log({type: 'log', message: \"Selling Hours: \" + req.body.value});\n                utility.log({type: 'log', message: \"team_member: \" + data[0]});\n                utility.log({type: 'log', message: \"store_id: \" + data[1]});\n                utility.log({type: 'log', message: \"date: \" + data[2]});\n\n                var hours = {\n                    selling_hours: req.body.value,\n                    team_member: data[0],\n                    store_id: data[1],\n                    date: data[2]\n                };\n                sellingHoursModel.create(hours, (err, result) => {\n                    if (err) {\n                        return res.end('Error: ' + err.message);\n                    }\n                    res.send(JSON.stringify(req.body));\n                });\n            }\n            else\n                res.send(JSON.stringify(req.body));\n        });\n    }\n});\n//Delete weekly hours\nrouter.post('/delete-hours', ensureAuthenticated, (req, res, next) => {\n    var aDate = moment(req.body.hiddenDate).format(\"YYYY-MM-DD\");\n    console.log(aDate);\n    sellingHoursModel.deleteCurrentWeekHours(aDate,(err,result) =>\n    {\n        if (err) {\n            return res.end('Error: ' + err.message);\n        }\n        return res.redirect('/users/selling-hours');\n    });\n});\n\n//Filter by week\nrouter.post('/update-week', ensureAuthenticated, (req, res, next) => {\n        var selectedDate = req.body.dateRange;\n        sellingHoursModel.getHoursByDate(req.session.store_id,selectedDate, (err,result) =>\n    {\n        if (err) {\n            throw next(err);\n        } //end if)\n        returnObj['hours'] = result;\n        returnObj['hoursObj'] = JSON.stringify(result);\n        returnObj['selectedDate'] = selectedDate;\n        console.log(returnObj['selectedDate']);\n        if (req.session.success) {\n            req.flash('success_messages', 'success');\n            req.session.success = false;\n        }  //end if\n        return res.render('selling-hours/selling-hours', returnObj);\n    });\n});\n\nrouter.post('/budgets', ensureAuthenticated, (req, res, next) => {\n    var data = req.body.name;\n    data = data.split(',');\n\n    utility.log({ type: 'log', message: data + 'store id from field' });\n\n    sellingHoursModel.getBudgetsWithStore([endOfWeek,data[2]], (err, result) => {\n        if (err) {\n            return res.end('Error: ' + err.message);\n        }\n\n        var budget = {\n            CTs: undefined,\n            revenue: undefined,\n            aotm: undefined,\n            ls: undefined,\n            date: endOfWeek,\n            store_id: data[2]\n        };\n\n        //Update\n        if(result != 0) {\n            budget['CTs'] = result[0].CTs;\n            budget['revenue'] = result[0].revenue;\n            budget['aotm'] = result[0].aotm;\n            budget['ls'] = result[0].ls;\n        }\n\n        var budgetType = data[0];\n        switch(budgetType){\n            case 'CTs':\n                budget['CTs'] = req.body.value;\n                break;\n            case 'revenue':\n                budget['revenue'] = req.body.value;\n                break;\n            case 'aotm':\n                budget['aotm'] = req.body.value;\n                break;\n            case 'ls':\n                budget['ls'] = req.body.value;\n                break;\n        }\n        if(result == 0){\n            sellingHoursModel.createBudgets(budget, (err, result) => {\n                if (err) {\n                    return res.end('Error creating: ' + err.message);\n                }\n                res.send(JSON.stringify(req.body));\n            });\n        } else {\n            sellingHoursModel.updateBudgets([budget['CTs'], budget['revenue'], budget['aotm'], budget['ls'], budget['date'], budget['store_id']], (err, result) => {\n                if (err) {\n                    return res.end('Error updating: ' + err.message);\n                }\n\n                res.send(JSON.stringify(req.body));\n            });\n        }\n    });\n});\n\n// Ensure sure the user is authenticated\nfunction ensureAuthenticated(req, res, next) {\n    if (req.isAuthenticated()) { return next(); }\n    res.redirect('/');\n}\n\nmodule.exports = router;"]}