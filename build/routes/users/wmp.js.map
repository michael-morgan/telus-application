{"version":3,"sources":["wmp.es6"],"names":[],"mappings":"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","file":"wmp.js","sourcesContent":["/**\r\n * Created by Jacob on 2016-05-29.\r\n */\r\nvar express = require('express');\r\nvar connection = require('../../connection');\r\nvar passport = require('passport');\r\n\r\nvar userModel = require('../../models/user');\r\nvar storeModel = require('../../models/store');\r\nvar sellingHoursModel = require('../../models/selling-hours');\r\nvar returnObj = {};\r\nvar router = express.Router();\r\n\r\nvar moment = require('../../bower_components/bootstrap-daterangepicker/moment.min.js');\r\nvar endOfWeek = moment().startOf('isoWeek').add(5,'day').format('YYYY-MM-DD');\r\nvar currentDate = moment().format(\"yyyy-MM-DD\")\r\n\r\nrouter.get('/', ensureAuthenticated, function (req, res, next) {\r\n    //Ensure user is logged in\r\n    if (req.user.privileged <= 2) {\r\n        return res.redirect('/users/');\r\n    }\r\n\r\n    returnObj['title'] = 'WMP';\r\n    returnObj['message'] = undefined;\r\n\r\n    storeModel.getStoresByTNumber(req.user.t_number, (err, result) => {\r\n        if (err) {\r\n            throw next(err);\r\n        } //end if\r\n\r\n        let storesResult = result;\r\n\r\n        returnObj['stores'] = storesResult;\r\n        returnObj['currentStore'] = storesResult.find((store) => store.store_id == req.session.store_id);\r\n        returnObj['storesObj'] = JSON.stringify(returnObj['stores']);\r\n\r\n        let storeIds = [];\r\n        for(let storeIndex in returnObj['stores']) {\r\n            if(!returnObj['stores'].hasOwnProperty(storeIndex)) { continue; }\r\n            storeIds.push(returnObj['stores'][storeIndex].store_id);\r\n        }\r\n\r\n        userModel.getAllUsersByStoreIds(storeIds, (err, result) => {\r\n            if (err) {\r\n                throw next(err);\r\n            } //end if\r\n\r\n            returnObj['users'] = [];\r\n            result.forEach((user) => {\r\n                delete user['password'];\r\n                returnObj['users'].push(user);\r\n            });\r\n\r\n            returnObj['usersObj'] = JSON.stringify(returnObj['users']);\r\n            returnObj['selectedEmployee'] = req.user.t_number;\r\n\r\n            sellingHoursModel.getHoursByStoreId(req.session.store_id, (err, result) => {\r\n                if (err) {\r\n                    throw next(err);\r\n                } //end if\r\n\r\n                let hoursResult = result;\r\n\r\n                returnObj['hours'] = hoursResult;\r\n                returnObj['hoursObj'] = JSON.stringify(hoursResult);\r\n\r\n                let storeTotalHours = 0;\r\n                returnObj['users'].forEach((user, userIndex, userArray) => {\r\n                    if(user.privileged == 5) { return; }\r\n\r\n                    userArray[userIndex]['hours'] = hoursResult.filter((row) => row.team_member == user.t_number);\r\n\r\n                    let total = 0;\r\n                    for (let hourIndex in userArray[userIndex]['hours']) {\r\n                        total += userArray[userIndex]['hours'][hourIndex].selling_hours;\r\n                    }\r\n\r\n                    userArray[userIndex]['totalHours'] = total;\r\n                    storeTotalHours += total;\r\n                });\r\n\r\n                returnObj['stores'][returnObj['stores'].findIndex(\r\n                    (store) => store.store_id == req.session.store_id\r\n                )]['totalHours'] = storeTotalHours;\r\n                returnObj['currentStore']['totalHours'] = storeTotalHours;\r\n\r\n                returnObj['users'].forEach((user, userIndex, userArray) => {\r\n                    userArray[userIndex]['hoursPercent'] = ((userArray[userIndex]['totalHours'] / storeTotalHours) * 100);\r\n                });\r\n\r\n                //Bradley wrote this\r\n                sellingHoursModel.getBudgetsWithStore([endOfWeek, req.session.store_id], (err, result) => {\r\n                    if (err) {\r\n                        throw next(err);\r\n                    } //end if\r\n\r\n                    let budgetsResult = result;\r\n\r\n                    returnObj['budgets'] = budgetsResult;\r\n                    returnObj['budgetsObj'] = JSON.stringify(budgetsResult);\r\n\r\n\r\n                    res.render('wmp', returnObj);\r\n\r\n                });\r\n            });\r\n        });\r\n    });\r\n});\r\n\r\nrouter.post('/', ensureAuthenticated, (req, res, next) => {\r\n    if(req.body.dateRange != undefined && req.body.dateRange != '') {\r\n        var selectedDate = req.body.dateRange;\r\n        sellingHoursModel.getHoursByDate(req.session.store_id, selectedDate, (err, result) => {\r\n            if (err) {\r\n                throw next(err);\r\n            } //end if)\r\n            returnObj['hours'] = result;\r\n            returnObj['hoursObj'] = JSON.stringify(result);\r\n            returnObj['selectedDate'] = selectedDate;\r\n            console.log(returnObj['selectedDate']);\r\n            if (req.session.success) {\r\n                req.flash('success_messages', 'success');\r\n                req.session.success = false;\r\n            }  //end if\r\n            return res.redirect('/users/wmp');\r\n        });\r\n    }\r\n    else {\r\n        var data = req.body.name;\r\n        data = data.split(',');\r\n        for (var aData in data) {\r\n            console.log(aData);\r\n        }\r\n        //Update selling hours\r\n        sellingHoursModel.updateHoursByID([req.body.value, data[0], data[1], data[2]], (err, result) => {\r\n            if (err) {\r\n                return res.end('Error: ' + err.message);\r\n            }\r\n\r\n            //No rows affected, guess we have to insert\r\n            if (result == 0) {\r\n                utility.log({type: 'log', message: \"Selling Hours: \" + req.body.value});\r\n                utility.log({type: 'log', message: \"team_member: \" + data[0]});\r\n                utility.log({type: 'log', message: \"store_id: \" + data[1]});\r\n                utility.log({type: 'log', message: \"date: \" + data[2]});\r\n\r\n                var hours = {\r\n                    selling_hours: req.body.value,\r\n                    team_member: data[0],\r\n                    store_id: data[1],\r\n                    date: data[2]\r\n                };\r\n                sellingHoursModel.create(hours, (err, result) => {\r\n                    if (err) {\r\n                        return res.end('Error: ' + err.message);\r\n                    }\r\n                    res.send(JSON.stringify(req.body));\r\n                });\r\n            }\r\n            else\r\n                res.send(JSON.stringify(req.body));\r\n        });\r\n    }\r\n});\r\n\r\n//When a date is selected in the date picker, it reloads the page\r\n//Since there is only dummy data on the WMP page, this code doesn't actually update anything\r\nrouter.post('/ss', ensureAuthenticated, (req, res, next) => {\r\n    var selectedDate = req.body.dateRange;\r\n    returnObj['selectedDate'] = selectedDate;\r\n    console.log(returnObj['selectedDate']);\r\n    if (req.session.success) {\r\n        req.flash('success_messages', 'success');\r\n        req.session.success = false;\r\n    }  //end if\r\n    res.redirect('/users/wmp');\r\n});\r\n\r\n// Ensure sure the user is authenticated\r\nfunction ensureAuthenticated(req, res, next) {\r\n    if (req.isAuthenticated()) { return next(); }\r\n    res.redirect('/');\r\n}\r\nmodule.exports = router;"]}